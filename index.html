<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trích Từ | Cỗ Máy Đọc Chữ AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; padding-bottom: 50px; }
        .clickable-word { cursor: pointer; padding: 2px 6px; border-radius: 6px; transition: 0.2s; display: inline-block; line-height: 1.6; }
        .clickable-word:hover { background-color: #dbeafe; }
        .highlighted-text { background-color: #fef08a !important; color: #dc2626; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transform: scale(1.1); }
        .hidden { display: none !important; }
        /* Tùy chỉnh thanh trượt slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #a855f7; cursor: pointer; margin-top: -6px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-8 relative min-h-screen">

    <div class="max-w-5xl mx-auto">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-orange-200">
            <h2 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500 mb-6 flex items-center justify-center">
                <i class="fas fa-robot mr-3 text-orange-500"></i> Cỗ Máy Đọc Chữ Bằng Mắt Thần AI
            </h2>

            <div class="bg-yellow-50 p-5 rounded-xl border-2 border-dashed border-yellow-400 mb-6 relative">
                <strong class="text-yellow-800 flex items-center gap-2 mb-2"><i class="fas fa-key"></i> Chìa Khóa Ma Thuật (API Key) của Groq:</strong>
                <input type="password" id="api-key-groq" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-yellow-400 outline-none" placeholder="Dán mã gsk_... của bạn vào đây nhé!">
                <div id="save-status-groq" class="text-green-600 text-sm font-bold mt-2 hidden"><i class="fas fa-check-circle"></i> Chìa khóa đã được cất vào túi thần kỳ! Lần sau không cần nhập lại.</div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-lg text-slate-700 mb-4"><i class="fas fa-image text-blue-500"></i> 1. Đưa ảnh vào máy</h3>
                    
                    <label class="block text-sm font-bold text-slate-600 mb-1">Bạn muốn Robot đọc tiếng gì?</label>
                    <select id="lang-select" class="w-full border p-3 rounded-xl mb-4 bg-white focus:ring-2 focus:ring-blue-400 outline-none">
                        <option value="eng">Chỉ đọc Tiếng Anh</option>
                        <option value="vie">Chỉ đọc Tiếng Việt</option>
                    </select>

                    <label class="block text-sm font-bold text-slate-600 mb-1">Cách lấy ảnh:</label>
                    <div class="flex gap-2 mb-4">
                        <button onclick="startCamera()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-sm flex items-center justify-center gap-2">
                            <i class="fas fa-camera"></i> Chụp ngay
                        </button>
                        <div class="flex-1 relative">
                            <input type="file" id="image-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="bg-white border-2 border-blue-200 text-blue-600 h-full flex items-center justify-center rounded-xl font-bold pointer-events-none hover:bg-blue-50 transition">
                                <i class="fas fa-folder-open mr-2"></i> Tải ảnh lên
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <img id="image-preview" alt="Ảnh của bạn" class="max-w-full rounded-xl border-2 border-slate-200 hidden">
                    </div>
                </div>

                <div class="bg-orange-50 p-6 rounded-2xl border border-orange-100 flex flex-col">
                    
                    <button onclick="openFullscreenResult()" class="w-full flex items-center justify-between font-bold text-lg text-orange-800 mb-4 bg-orange-100 p-3 rounded-xl border border-orange-200 shadow-sm hover:bg-orange-200 transition">
                        <span class="flex items-center gap-2"><i class="fas fa-expand text-orange-500"></i> 2. Văn bản đã xử lý</span>
                        <span class="text-sm font-normal text-orange-600 bg-white px-2 py-1 rounded-lg border border-orange-300">Phóng to <i class="fas fa-arrows-alt ml-1"></i></span>
                    </button>
                    
                    <div id="status-groq" class="font-bold text-orange-600 text-center mb-4 bg-white p-2 rounded-lg border border-orange-200">Hãy đưa ảnh vào để Robot bắt đầu làm việc nhé!</div>
                    
                    <div id="text-output-placeholder" class="hidden">
                        <div id="text-output" class="bg-white p-4 flex-1 rounded-xl text-lg leading-relaxed border-2 border-green-200 mb-4 shadow-inner min-h-[150px]">Chữ sẽ hiện ra ở đây. Bạn hãy <b class="text-red-500">bấm vào chữ</b> để tô màu nhé!</div>
                    </div>

                    <div id="gom-buttons-placeholder" class="hidden">
                        <div class="grid grid-cols-2 gap-2 mb-4" id="gom-buttons-container">
                            <button onclick="getHighlights(', ')" class="bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition shadow-sm text-sm flex justify-center items-center gap-2">
                                <i class="fas fa-quote-right"></i> Gom (Dấu phẩy)
                            </button>
                            <button onclick="getHighlights('\n')" class="bg-emerald-500 text-white py-3 rounded-xl font-bold hover:bg-emerald-600 transition shadow-sm text-sm flex justify-center items-center gap-2">
                                <i class="fas fa-level-down-alt"></i> Gom (Xuống hàng)
                            </button>
                        </div>
                    </div>

                    <h3 class="font-bold text-sm text-slate-600 mb-2 mt-2"><i class="fas fa-shopping-basket text-slate-400"></i> Giỏ đựng chữ của bạn:</h3>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="flex flex-col gap-2">
                            <textarea id="final-output-comma" class="w-full h-28 border-2 border-orange-200 rounded-xl p-3 focus:ring-2 focus:ring-orange-400 outline-none text-slate-700 text-sm" placeholder="Ngăn 1: Từ 1, Từ 2..."></textarea>
                            <button onclick="copyToClipboard('final-output-comma')" class="bg-orange-100 text-orange-700 py-2 rounded-lg hover:bg-orange-200 transition text-xs font-bold w-full border border-orange-300">
                                <i class="fas fa-copy"></i> Copy tất cả
                            </button>
                        </div>
                        
                        <div class="flex flex-col gap-2">
                            <textarea id="final-output-newline" class="w-full h-28 border-2 border-emerald-200 rounded-xl p-3 focus:ring-2 focus:ring-emerald-400 outline-none text-slate-700 text-sm leading-tight" placeholder="Ngăn 2:&#10;Từ 1&#10;Từ 2..."></textarea>
                            <button onclick="copyToClipboard('final-output-newline')" class="bg-emerald-100 text-emerald-700 py-2 rounded-lg hover:bg-emerald-200 transition text-xs font-bold w-full border border-emerald-300">
                                <i class="fas fa-copy"></i> Copy tất cả
                            </button>
                        </div>
                    </div>

                    <div>
                        <a href="https://tratutienganh.netlify.app/" target="_blank" class="w-full flex justify-center items-center bg-indigo-500 text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition shadow-sm gap-2">
                            <i class="fas fa-language text-xl"></i> Dịch sang Web Từ Điển
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="camera-container" class="hidden fixed inset-0 z-[100] bg-black flex flex-col justify-center items-center">
        <video id="camera-feed" autoplay playsinline class="w-full h-full object-contain"></video>
        <button onclick="captureImage()" class="absolute bottom-10 bg-red-500 text-white px-8 py-4 rounded-full font-bold shadow-2xl border-4 border-white hover:bg-red-600 flex items-center gap-2 text-xl z-50">
            <i class="fas fa-camera"></i> Chụp ảnh
        </button>
        <button onclick="stopCamera()" class="absolute top-4 right-4 bg-gray-800 bg-opacity-70 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-gray-900 text-xl z-50">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div id="edit-overlay" class="hidden fixed inset-0 z-[100] bg-black flex flex-col justify-center items-center">
        <div class="w-full h-[80vh] flex justify-center items-center p-4 relative">
            <img id="overlay-image" class="max-w-full max-h-full object-contain block">
        </div>
        
        <div id="review-controls" class="absolute bottom-10 flex gap-4 w-full justify-center px-4">
            <button onclick="startEdit()" class="flex-1 max-w-[150px] bg-purple-500 text-white py-3 rounded-xl font-bold hover:bg-purple-600 shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-edit"></i> Chỉnh sửa
            </button>
            <button onclick="uploadAndRead()" class="flex-1 max-w-[150px] bg-blue-500 text-white py-3 rounded-xl font-bold hover:bg-blue-600 shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-upload"></i> Tải ảnh lên
            </button>
        </div>

        <div id="edit-controls" class="hidden absolute bottom-6 flex flex-col gap-4 w-full justify-center px-4">
            
            <div class="bg-gray-900 bg-opacity-75 p-3 rounded-2xl flex items-center gap-4 w-full max-w-sm mx-auto shadow-lg backdrop-blur-sm border border-gray-700">
                <i class="fas fa-search-minus text-white opacity-80"></i>
                <input type="range" id="zoom-slider" min="0.1" max="3" step="0.05" value="1" class="flex-1">
                <i class="fas fa-search-plus text-white opacity-80"></i>
            </div>
            
            <div class="flex gap-2 w-full justify-center max-w-sm mx-auto">
                <button onclick="rotateImage()" class="flex-1 max-w-[100px] bg-yellow-500 text-white py-3 rounded-xl font-bold hover:bg-yellow-600 shadow-lg flex items-center justify-center gap-1">
                    <i class="fas fa-undo"></i> Xoay
                </button>
                <button onclick="applyEdit()" class="flex-1 max-w-[100px] bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 shadow-lg flex items-center justify-center gap-1">
                    <i class="fas fa-check"></i> Xong
                </button>
                <button onclick="cancelEdit()" class="flex-1 max-w-[100px] bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 shadow-lg flex items-center justify-center gap-1">
                    <i class="fas fa-times"></i> Thoát
                </button>
            </div>
        </div>
    </div>

    <div id="result-overlay" class="hidden fixed inset-0 z-[110] bg-slate-50 flex flex-col h-[100dvh]">
        <div class="bg-orange-500 text-white p-4 flex justify-between items-center shadow-md">
            <h3 class="font-bold text-lg"><i class="fas fa-magic"></i> Văn bản đã xử lý</h3>
            <button onclick="closeFullscreenResult()" class="text-white hover:text-orange-200 text-2xl w-10 h-10 flex items-center justify-center bg-orange-600 rounded-full"><i class="fas fa-times"></i></button>
        </div>
        
        <div id="fullscreen-text-body" class="flex-1 p-4 overflow-y-auto">
            </div>
        
        <div class="bg-white p-4 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.1)] z-10" id="fullscreen-gom-buttons">
            </div>
    </div>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const textOutput = document.getElementById('text-output');
        const statusTextGroq = document.getElementById('status-groq');
        const apiKeyInputGroq = document.getElementById('api-key-groq');
        const langSelectGroq = document.getElementById('lang-select');
        const saveStatusGroq = document.getElementById('save-status-groq');
        
        let cameraStream = null;
        let currentCropper = null;
        let originalUneditedImage = ""; 
        let initialZoom = 1; // Biến lưu độ thu phóng gốc
        let isSliding = false; // Biến cờ xử lý chống xung đột khi kéo slider

        if (localStorage.getItem('myGroqKey')) {
            apiKeyInputGroq.value = localStorage.getItem('myGroqKey');
        }

        apiKeyInputGroq.addEventListener('input', function() {
            localStorage.setItem('myGroqKey', this.value.trim());
            saveStatusGroq.classList.remove('hidden');
            setTimeout(() => { saveStatusGroq.classList.add('hidden'); }, 3000); 
        });

        // 1. UPLOAD ẢNH TỪ FILE
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!apiKeyInputGroq.value) {
                alert("Ối! Bạn quên nhập Chìa khóa ma thuật Groq rồi!");
                imageUpload.value = ''; 
                return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                processImageToCanvas(event.target.result);
            };
            reader.readAsDataURL(file);
        });

        // 2. CAMERA
        async function startCamera() {
            if (!apiKeyInputGroq.value) {
                alert("Ối! Nhập mã API Groq trước khi chụp nhé!");
                return;
            }
            const video = document.getElementById('camera-feed');
            const container = document.getElementById('camera-container');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
                container.classList.remove('hidden'); 
            } catch (err) {
                alert("Không thể mở camera: " + err.message);
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('camera-container').classList.add('hidden');
        }

        function captureImage() {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL('image/jpeg', 0.9);
            stopCamera();
            processImageToCanvas(base64Image); 
        }

        function processImageToCanvas(imageSrc) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 1200;
                const MAX_HEIGHT = 1200;
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                } else {
                    if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const base64Image = canvas.toDataURL('image/jpeg', 0.8);

                document.getElementById('overlay-image').src = base64Image;
                document.getElementById('edit-overlay').classList.remove('hidden');
                document.getElementById('review-controls').classList.remove('hidden');
                document.getElementById('edit-controls').classList.add('hidden');
            };
            img.src = imageSrc;
        }

        // 3. LOGIC CHỈNH SỬA & THANH TRƯỢT THU PHÓNG (ĐÃ FIX ZOOM)
        function startEdit() {
            const img = document.getElementById('overlay-image');
            originalUneditedImage = img.src; 

            document.getElementById('review-controls').classList.add('hidden');
            document.getElementById('edit-controls').classList.remove('hidden');

            currentCropper = new Cropper(img, {
                viewMode: 0,          // Sử dụng viewMode 0 thay vì 1 để cho phép thu nhỏ thoải mái
                autoCropArea: 0.8,
                background: true,
                zoomable: true,       
                zoomOnTouch: true,    
                zoomOnWheel: false,
                ready: function () {
                    const canvasData = currentCropper.getCanvasData();
                    initialZoom = canvasData.width / canvasData.naturalWidth;
                    document.getElementById('zoom-slider').value = 1;
                },
                zoom: function(e) {
                    if (!isSliding && initialZoom > 0) {
                        document.getElementById('zoom-slider').value = e.detail.ratio / initialZoom;
                    }
                }
            });
        }

        const zoomSlider = document.getElementById('zoom-slider');

        zoomSlider.addEventListener('input', function(e) {
            isSliding = true; 
            if (currentCropper && initialZoom > 0) {
                currentCropper.zoomTo(parseFloat(e.target.value) * initialZoom);
            }
        });

        zoomSlider.addEventListener('change', function() {
            isSliding = false;
        });

        function rotateImage() {
            if (currentCropper) currentCropper.rotate(90);
        }

        function applyEdit() {
            if (!currentCropper) return;
            const canvas = currentCropper.getCroppedCanvas();
            const base64Image = canvas.toDataURL('image/jpeg', 0.9);
            currentCropper.destroy();
            currentCropper = null;
            document.getElementById('overlay-image').src = base64Image;
            document.getElementById('review-controls').classList.remove('hidden');
            document.getElementById('edit-controls').classList.add('hidden');
        }

        function cancelEdit() {
            if (!currentCropper) return;
            currentCropper.destroy();
            currentCropper = null;
            document.getElementById('overlay-image').src = originalUneditedImage;
            document.getElementById('review-controls').classList.remove('hidden');
            document.getElementById('edit-controls').classList.add('hidden');
        }

        function uploadAndRead() {
            const finalImageSrc = document.getElementById('overlay-image').src;
            document.getElementById('edit-overlay').classList.add('hidden');
            
            // Khôi phục hiển thị ảnh xem trước
            imagePreview.src = finalImageSrc;
            imagePreview.classList.remove('hidden');

            askGroqRobot(finalImageSrc);
        }

        // 4. API GROQ (GIỮ NGUYÊN)
        async function askGroqRobot(base64Image) {
            statusTextGroq.innerHTML = "<i class='fas fa-cog fa-spin'></i> Bạn Robot Llama 4 đang chép bài... Chờ chút nhé!";
            statusTextGroq.className = "font-bold text-orange-600 text-center mb-4 bg-orange-50 p-2 rounded-lg border border-orange-200";
            textOutput.innerHTML = "";
            
            let promptText = "Bạn là một cái máy photocopy không có khả năng suy nghĩ. Nhiệm vụ DUY NHẤT của bạn là chép lại y nguyên các chữ nhìn thấy trong ảnh. TUYỆT ĐỐI KHÔNG giải bài tập, KHÔNG điền vào chỗ trống, KHÔNG dịch thuật. BẮT BUỘC: Phải dùng đúng dấu phẩy, dấu chấm, và XUỐNG HÀNG y như trong ảnh tải lên. KHÔNG ĐƯỢC tự ý thay thế hoặc tóm tắt bất kỳ chữ nào. Nếu có chữ nào bị mờ, che khuất hoặc không nhận được, hãy hiện dấu '###' (1 chữ không đọc được = 1 dấu '###').";
            if (langSelectGroq.value === 'eng') {
                promptText = "You are a passive photocopy machine. Your ONLY job is to transcribe exactly the text in the image. DO NOT solve exercises. MANDATORY: You must strictly use the exact commas, periods, and LINE BREAKS as they appear in the image. DO NOT substitute or summarize any word. For any word that is unreadable or unrecognized, output '###' (one '###' for each unreadable word).";
            }

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKeyInputGroq.value.trim()}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                        messages: [
                            { role: 'user', content: [ { type: 'text', text: promptText }, { type: 'image_url', image_url: { url: base64Image } } ] }
                        ],
                        temperature: 0 
                    })
                });

                if (!response.ok) throw new Error((await response.json()).error?.message || "Lỗi không xác định từ máy chủ!");

                const data = await response.json();
                const text = data.choices[0].message.content;

                statusTextGroq.innerHTML = "<i class='fas fa-check-circle'></i> Robot đã chép xong! Hãy bấm 'Văn bản đã xử lý' để phóng to và tô màu nhé!";
                statusTextGroq.className = "font-bold text-green-600 text-center mb-4 bg-green-50 p-2 rounded-lg border border-green-200";

                const formattedText = text.split('\n').map(line => {
                    return line.split(' ').map(word => {
                        if (!word.trim()) return word; 
                        return `<span class="clickable-word">${word}</span>`;
                    }).join(' ');
                }).join('<br>'); 

                textOutput.innerHTML = formattedText;
                addClickMagic();

            } catch (error) {
                statusTextGroq.innerHTML = "<i class='fas fa-exclamation-triangle'></i> Lỗi rồi: " + error.message;
                statusTextGroq.className = "font-bold text-red-600 text-center mb-4 bg-red-50 p-2 rounded-lg border border-red-200";
            }
        }

        function addClickMagic() {
            const words = document.querySelectorAll('.clickable-word');
            words.forEach(word => {
                word.addEventListener('click', function() { this.classList.toggle('highlighted-text'); });
            });
        }

        // 5. MỞ / ĐÓNG GIAO DIỆN KẾT QUẢ FULL MÀN HÌNH (GIỮ NGUYÊN)
        function openFullscreenResult() {
            const textEl = document.getElementById('text-output');
            const btnsEl = document.getElementById('gom-buttons-container');
            
            textEl.classList.remove('min-h-[150px]', 'mb-4', 'border-2', 'border-green-200', 'rounded-xl');
            textEl.classList.add('min-h-full', 'text-xl', 'border-0', 'bg-transparent', 'p-0');
            btnsEl.classList.remove('mb-4');
            
            document.getElementById('fullscreen-text-body').appendChild(textEl);
            document.getElementById('fullscreen-gom-buttons').appendChild(btnsEl);
            
            document.getElementById('result-overlay').classList.remove('hidden');
        }

        function closeFullscreenResult() {
            const textEl = document.getElementById('text-output');
            const btnsEl = document.getElementById('gom-buttons-container');
            
            textEl.classList.add('min-h-[150px]', 'mb-4', 'border-2', 'border-green-200', 'rounded-xl', 'bg-white', 'p-4');
            textEl.classList.remove('min-h-full', 'text-xl', 'border-0', 'bg-transparent', 'p-0');
            btnsEl.classList.add('mb-4');
            
            document.getElementById('text-output-placeholder').appendChild(textEl);
            document.getElementById('gom-buttons-placeholder').appendChild(btnsEl);
            
            document.getElementById('result-overlay').classList.add('hidden');
        }

        // 6. GOM TỪ VÀ TỰ ĐỘNG THU NHỎ LẠI (GIỮ NGUYÊN)
        function getHighlights(separator) {
            const highlights = document.querySelectorAll('.highlighted-text');
            if (highlights.length === 0) {
                alert("Bạn chưa tô màu chữ nào cả!");
                return;
            }
            const texts = Array.from(highlights).map(el => {
                return el.textContent.trim().replace(/^[\.,!?;:]+|[\.,!?;:]+$/g, '');
            });
            const resultText = texts.filter(t => t).join(separator);
            
            if (separator === ', ') {
                document.getElementById('final-output-comma').value = resultText;
            } else {
                document.getElementById('final-output-newline').value = resultText;
            }

            if (!document.getElementById('result-overlay').classList.contains('hidden')) {
                closeFullscreenResult();
                document.getElementById('final-output-comma').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 7. COPY VĂN BẢN (GIỮ NGUYÊN)
        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            if (!textarea.value) { alert("Ngăn chứa này đang trống!"); return; }
            textarea.select();
            textarea.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert("Đã copy toàn bộ chữ thành công!");
            }).catch(err => {
                alert("Copy thất bại, vui lòng bôi đen và copy thủ công.");
            });
        }
    </script>
</body>
</html>
